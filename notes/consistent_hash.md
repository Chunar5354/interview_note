## 一致性hash

[参考1](https://segmentfault.com/a/1190000021199728)

[参考2](https://www.zsythink.net/archives/1182)

一致性hash算法是为了解决分布式系统中`节点定位`的问题

使用传统hash算法，需要用key的hash值`对节点总数取模`来获得当前key位于哪个节点中，但是在分布式系统中，很有可能出现节点数的变化（某个节点宕机或新增节点），当节点总数发生变化，原来的键值对就`不可用了`

### 一致性hash算法的原理

一致性hash通过`一致性hash环`来实现，环的起点是0，重点是2^32-1，并首尾相连

- 对象存储

最开始和普通哈希算法一样计算`对象`(用o表示）和`服务器`（用s表示）的hash值，并添加到hash环的相应位置（环上的值都是计算后的hash值）

[![cIwYQg.png](https://z3.ax1x.com/2021/04/18/cIwYQg.png)](https://imgtu.com/i/cIwYQg)

然后每个对象`顺时针`查找距离这个对象`最近`的服务器，就是这个对象存放的服务器，所以在上面的途中o1存放到s1，o2存放到s2，o3和o4存放到s3

- 增加服务器

假设某一个时刻新增了一个服务器s4，落在s2和s3中间

[![cIwWwR.png](https://z3.ax1x.com/2021/04/18/cIwWwR.png)](https://imgtu.com/i/cIwWwR)

此时只有s2和s3中间的对象存储位置可能发生改变（实际上只有o3的位置从s3变到了s4），其它的对象位置都不会变化

- 减少服务器

假设某一个时刻s1服务器宕机

[![cIw5Y6.png](https://z3.ax1x.com/2021/04/18/cIw5Y6.png)](https://imgtu.com/i/cIw5Y6)

此时只会影响到原来存储在s1上的对象，它们会向后继续查找并存储在s2上，不会影响其它对象的存储

### 一致性hash算法的优点

- 1.一致性hash算法使得在增加和减少节点时，`数据的移动大大减少`

- 2.更好的适应数据的快速增长，当数据不断增加导致部分节点包含过多数据时，可以通过虚拟节点的方式来`调整数据的分布`（具体见下节）

### 一致性hash算法的缺点与解决方法

- 哈希偏斜导致的负载不均衡

理想情况下，服务器节点在哈希环上应该是均匀分布的，但实际上可能出现下面的情况

[![cI0OvF.png](https://z3.ax1x.com/2021/04/18/cI0OvF.png)](https://imgtu.com/i/cI0OvF)

这样就导致大量的对象存储到了s1中，而s2与s3比较空闲

- 解决方法：虚拟节点

为了让对象的分布更加均匀，可以让节点“多”起来，即为物理节点复制出一些虚拟节点（vs）

[![cIBEKe.png](https://z3.ax1x.com/2021/04/18/cIBEKe.png)](https://imgtu.com/i/cIBEKe)

虚拟节点实际会指向物理节点，所以在上图中，最终o1和o2存储在s1上，o3存储在s3上，o4存储在s2上