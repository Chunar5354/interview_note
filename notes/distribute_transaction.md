[参考](https://xiaomi-info.github.io/2020/01/02/distributed-transaction/)

## 基本概念

### 分布式事务

分布式事务指的是事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上

分布式事务的目的是要保证不同节点的`数据一致性`

### 强一致性，弱一致性和最终一致性

- 强一致性指的是`任意时刻所有节点`的数据都是一样的

- 弱一致性指的是数据更新之后能够容忍后续的访问只访问到`一部分`或者`全部访问不到`

- 最终一致性指的是不保证任意时刻所有节点的数据相同，但是所有节点的数据都在趋向一致而变化，在`一段时间后`所有节点的数据最终会相同

### CAP理论

CAP定理指对于一个分布式系统，不可能同时满足以下三点：

- 1.Consistency，一致性，即在某一时刻访问所有节点，能得到相同的数据

- 2.Availability，可用性，任意的节点在收到请求时必须给出响应

- 3.Partition tolerance，分区容错，允许某个时间间隔内节点数据不一致

分布式系统都要实现分区容错，所以P是一定要的，所以要在C和A中牺牲一个

### BASE理论

BASE（Basically Available Soft State Eventual Consistency），包裹以下几部分：

- BA: Bascilly Available，基本可用，指分布式系统在出现故障的时候，允许`损失部分可用性`，保证核心功能可用

- S: Soft State，软状态，允许系统存在`中间状态`，并且中间状态不会影响整体可用性

- E: Eventual Consistency，最终一致性，所有节点的数据`经过一定时间`能够达到一致

### 幂等性

相同的请求无论执行多少次，总是得到相同的结果

## 分布式事务解决方案

### 两阶段提交

把事务提交分为两个步骤：

- 1.事务管理器询问各个资源管理器`是否就绪`

- 2.如果全部就绪，就提交事务，否则`回滚`

这种方式存在一些问题：

- 1.同步阻塞，如果某一个事务参与者占用了公共资源，其他参与者就必须等待资源释放

- 2.单点故障，狗哥节点出现故障会导致整个系统不可用

- 3.数据不一致，在第二步提交的时候可能发生网络异常导致只有部分参与者提交了事务

- 4.不确定性，如果事务管理器和事务参与者同时宕机，新选举出的事务管理器无法确定之前的消息是否提交成功

### TCC

TCC（Try Confirm Cancel）分为三个阶段：

- 1.Try：尝试执行，完成所有业务检查（一致性），预留必须的业务资源（准隔离性）

- 2.Confirm：真正执行业务，不做检查，只适用Try阶段预留的资源，Confirm需要满足幂等性，失败后进行重试

- 3.Cancel：取消执行，释放Try阶段预留的资源

### 本地消息表

分为消息生产者（A）和消息消费者（B），步骤如下

- 1.A发生更新时，先更新A的数据库，再向消息表（消息队列）中发送一条消息

- 2.B取出消息表的消息，并更新B的数据库，如果失败，会通知A进行回滚