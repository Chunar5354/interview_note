ARP(Address Resolution Protocol)，地址解析协议，用于链路层寻址，即提供IP地址到MAC地址的映射

## MAC地址

MAC地址指的是主机或路由器上`适配器`具有的地址，每一个适配器的地址都是`独一无二`的，并且不会改变

MAC地址有6字节，通常由十六进制表示，形式如`1A-2B-3C-4D-5E-6F`

适配器可以接收`任何`目的MAC地址的帧，但只有目的MAC地址与自己的MAC地址`相同`时，才会将这个帧交付给上层

有一个特殊的广播MAC地址`FF-FF-FF-FF-FF-FF`，会被子网上所有的适配器接收并处理

## ARP协议

根据网络协议的层级结构，发送方执行到网络层后，还要继续向下通过网络适配器来打包并发送链路层帧

但是链路层通信需要知道目标主机的MAC地址，这就需要ARP协议来实现通过目标主机的IP地址来找到MAC地址的功能

### ARP的实现过程

每台主机或路由器在内存中维护一个`ARP表`，包含三个表项：`IP地址`、`MAC地址`和`TTL过期时间`

假设主机A（IP为111.111.111.111，MAC为AA-AA-AA-AA-AA-AA）要向同一子网下的主机B（IP为111.111.111.100，MAC为BB-BB-BB-BB-BB-BB）通信

有两种情况：

- 1.主机A的ARP表中已经存在了关于主机B的映射，直接可以根据B的IP地址得到B的MAC地址，发送链路层帧

[![RpqfnP.md.png](https://z3.ax1x.com/2021/06/18/RpqfnP.md.png)](https://imgtu.com/i/RpqfnP)

- 2.主机A中没有主机B的映射，为了获得B的MAC地址，A要构造一个`ARP分组`，它包含发送和接收IP及MAC地址，用来询问子网内`所有`其他主机和路由器，以确定IP地址111.111.111.100对应的MAC地址

这个询问操作是通过`广播MAC地址(FF-FF-FF-FF-FF-FF)`来完成的，局域网中的所有其它适配器都会收到这个广播帧，并将该帧中的ARP分组交付给ARP模块，这些ARP模块检查自身的IP地址是否与ARP分组中的`目的IP地址`相匹配，匹配的那个主机B给查询主机A返回一个带有所希望映射（111.111.111.100:BB=BB=BB=BB=BB+BB）的ARP分组

主机A得到这个响应之后`更新`自己的ARP表，然后就可以正常发送

### 跨子网的ARP

如果两台主机不在同一个子网下，ARP是如何执行的呢

假设有下面这样一个网络，两个子网由一个路由器所划分

[![RpXh0x.md.png](https://z3.ax1x.com/2021/06/18/RpXh0x.md.png)](https://imgtu.com/i/RpXh0x)

在这种情况下，主机A是不能跨越子网去得到主机B的MAC地址的，要与B进行通信，需要借助网关路由器，流程如下：

- 1.A首先通过广播得到路由器左侧端口的MAC地址（11-11-11-11-11-11），记录到ARP表中，以后需要跨越子网的帧都要发到这个端口

- 2.当一个帧从A发送到路由器后，路由器根据其转发表得知该帧需要由右侧的端口发到右侧的子网中

- 3.主机B的IP到MAC映射保存在路由器的ARP表中，从这里得到主机B的MAC地址就可以完成链路层的传输