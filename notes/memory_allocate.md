[参考](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/)

内存空间包含两个重要的区域：栈区和堆区

- 栈区包含函数调用的参数、返回值以及局部变量等，由`编译器`管理

- 堆区中的对象由`内存分配器`分配并由`垃圾回收器`回收

## 内存分配方法

### 线性分配器

只需维护一个指针，依次向后分配

优点：高效

缺点：无法重用被释放的内存，需要与合适的垃圾回收算法搭配使用

### 空闲链表分配器

需要维护多个指针，把每个不相连的空闲内存块连接成一个链表

优点：可以重用释放的内存

缺点：分配时需要遍历，复杂度为O(n)

Go的分配策略：`隔离适应`，将内存分成不同的链表，分配时先选择合适的链表，再从链表中选择合适的内存块，这样能够减少遍历的内存块数量

## 多级缓存

内存分配器会区别对待不同大小的对象，根据大小分为：

- 微对象，0~16B

- 小对象，16B~32K

- 大对象，32K以上

对这些不同大小的对象会将内存分成不同的级别来分别管理，从小到大分为：

- 线程缓存，每个线程独有的缓存

- 中心缓存，线程缓存不足时，作为补充

- 页堆，大对象直接分配在页堆上

## 虚拟内存布局

Go1.10以前使用的是线性内存，但线性内存需要假设堆区的内存是`连续的`，需要`预留`大量的内存空间，这一点很难实现

为了解决这个问题，在Go1.11版本之后使用了`二维稀疏内存`

## 内存管理

Go的内存管理组件有内存管理单元、线程缓存、中心缓存和页堆

### 内存管理单元

Go程序启动时会初始化内存布局，每个处理器会分配一个线程缓存`runtime.mcache`用于处理微对象和小对象的分配，它们持有内存管理单元[runtime.mspan](https://github.com/golang/go/blob/41d8e61a6b9d8f9db912626eb2bbc535e929fefc/src/runtime/mheap.go#L382)

`runtime.mspan`是Go最基本的内存管理单元，它是`双向链表`的一个节点，主要字段有：

```go
type mspan struct {
	next *mspan       // 前一个节点
	prev *mspan       // 后一个节点
	startAddr uintptr // 起始地址
	npages    uintptr // 页数
    ...
}
```

每个mspan管理npages个8KB大小的页

### 线程缓存

线程缓存[runtime.mcache](https://github.com/golang/go/blob/41d8e61a6b9d8f9db912626eb2bbc535e929fefc/src/runtime/mcache.go#L20)与线程上的`处理器`一一绑定，主要缓存用户申请的微笑对象

每一个线程缓存持有`68*2`个mspan

### 中心缓存

[runtime.mcentral](https://github.com/golang/go/blob/41d8e61a6b9d8f9db912626eb2bbc535e929fefc/src/runtime/mcentral.go#L20)是中心缓存

由于不是线程独有，访问中心缓存需要`加锁`

### 页堆

[runtime.heap](https://github.com/golang/go/blob/41d8e61a6b9d8f9db912626eb2bbc535e929fefc/src/runtime/mheap.go#L62)是页堆，也是内存分配的核心结构体，Go将其作为`全局变量`

页堆维护全局的中心缓存列表，包含`68*2`个中心缓存

## 内存分配

在堆上分配内存首会调用`runtime.mallocgc`，它会根据对象大小执行不同的分配逻辑

- 微对象：先使用微型分配器，再依次尝试线程缓存、中心缓存、页堆

- 小对象：依次尝试线程缓存、中心缓存、页堆

- 大对象：直接在页堆上分配

### 微对象

微对象使用`微型分配器`来分配，以`16字节`为一个内存块

分析分配器不能分配指针对象

### 小对象

小对象指的是16字节到32K字节的对象以及所有小于16字节的`指针`类型对象

有三个步骤：

- 1.确定分配对象的大小

- 2.依次尝试从线程缓存、中心缓存和页堆获取内存管理单元`mspan`并从内存管理单元中找到空闲的内存空间

- 3.`清空`空闲内存中的所有数据

### 大对象

大于32KB的大对象会直接分配在`页堆`上，并按照8KB的倍数在页堆上申请内存
