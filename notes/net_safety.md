## 密钥系统

密钥的目的就是对于发送方A，接收方B和报文m，用B的密钥解密经A的密钥加密的结果还是原来的报文m，即

```
K_b(K_a(m)) = m
```

有两种主要的密钥系统

- 1.对称密钥（DES，AES算法）：发送方A和接收方B的密钥`相同`，并且是`私密的`

- 2.公开密钥（RSA算法）：分为所有人都可以知道的`公钥`，和`只有一方`知道的`私钥`(A知道B的公钥K_p，B自己有私钥K_s，`K_s(K_p(m))=K_p(K_s(m))=m`)

对称加密要比公开加密方式`快得多`，通常是用公开加密方式`协商对称密钥`，后面都用对称密钥方式传输

## 报文完整性

接收方B需要证实报文m确实是由A发来的，并且中途没有被篡改

报文完整性依赖于散列函数

### 散列函数

散列函数H(x)的意义在于：不存在两个不同的报文x和y经过相同的散列函数计算出相同的结果，即`H(x)=H(y)`是不可能的

常用的散列算法有`MD5`

### 报文鉴别

过程如下：

- 1.A通过散列函数H(x)与鉴别密钥s计算`H(m+s)`（称为报文鉴别码，MAC）

- 2.A将将MAC附加到报文上，将扩展报文(m, H(m+s))发送给B

- 3.B也知道s和H(x)，通过H(m+s)验证是否和A发过来的MAC相同

## 数字签名

数字签名用于指出报文的所有者

做法是用`私钥`K_s对报文进行签名，另一方通过`公钥`K_p进行解密就可以确认

然而公钥私钥方法计算消耗比较高，所以通常是对`报文的散列`进行签名：

- A生成报文的散列H(m)，用私钥签名得到`K_p(H(m))`，将(m, K_p(H(m)))发送给B

- B用公钥解密签名得到`H(m)=K_s(K_p(H(m)))`，再自己计算H(m)来验证完整性

## 公钥认证

使用公钥私钥对进行加密时一个重要的问题是验证`收到的A的公钥确实属于A`

公钥认证是由认证中心（Certification Authority， CA）完成的

认证流程：

- CA验证了某个主体A的身份后，会生成一个将这个`主体的身份`和`主体的公钥`绑定的`证书`，然后由CA对证书进行`数字签名`

- A向B传输数据时会发送CA的证书，B通过`CA的公钥`解密证书，`拿到A的公钥`


## SSL与TLS

TLS（Transport Layer Security 传输层安全性）是升级版的SSL（Secure Socket Layer 安全套接字层）

SSL技术上位于应用层，可以认为介于应用层和传输层之间，它加强了TCP的安全性

SSL有三个阶段：握手，密钥导出和数据传输

假设A是Server，B是Client

### 握手

- B向A建立TCP连接，向A发送一个SSL hello报文

- A响应B，向B发送自己的`证书`

- B从证书中得到`A的公钥`，产生一个`主密钥MS`并使用A的公钥加密主密钥得到`EMS`，将EMS发送给A

- A用自己的私钥解密EMS得到MS，以后就可以用这个MS进行通信

### 密钥导出

A、B两方使用不同的密钥更加安全，所以A和B会用主密钥MS生成4个密钥：

- EB，B到A的会话加密密钥

- MB，B到A的MAC密钥（验证完整性）

- EA，A到B的会话加密密钥

- MA，A到B的MAC密钥

### 数据传输

SSL将数据流分割成记录r

B到A的过程：

- H(r+MB)得到报文鉴别码，然后`EB(r+H(r+MB))`发送给A
