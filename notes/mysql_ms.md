mysql主备复制的一些问题

## 主备复制的延迟

在备库上执行

```
show dlace status
```

可以看到一个参数`seconds_behind_master`，它表示主备延迟的时间（秒）

主备延迟有以下几种可能：

- 1.网络问题

- 2.可能备库机器的性能比主库要差

- 3.备库可能要分担一些读请求，压力较大

这种情况可以多设置一些从库，分担压力

- 4.长事务，导致备库重放时间过长

- 5.大表的DDL

## 主备切换的策略

### 可靠性优先

- 1.判断备库B的seconds_behind_master值，如果小于某一个设定值，就继续，否则持续等待

- 2.把主库A改成只读状态

- 3.等待备库B的seconds_behind_master直到为0（说明主备一致）

- 4.将备库B改成可读写

- 5.将请求切换到B，B成为新的主库

这种策略会在步骤3时`主备都不可用`一段时间

### 可用性优先

没有上面的步骤123，直接执行步骤4和5

这种策略可能导致`数据丢失`

## 主备复制的多线程模型

在mysql5.6版本之前，在从库上有两个线程：

- io_thread负责拷贝主库的binlog到从库的relay log中

- sql_thread负责重放relay log中的记录到从库

在5.6版本之后，sql_thread由`多线程`来实现，方式是：一个线程`coordinator`负责读取relay log，多个`worker`线程负责执行

coordinator在分发记录给worker时，需要遵守两个原则：

- 1.更新`同一行`的多个事务，必须分发到一个worker中

- 2.`同一个事务`的记录必须放到同一个worker中

## 读写分离

通常一主多从的方案中，主库主要用来写，从库用来读，以减轻主库的压力，但由于主从延迟的存在，在刚完成一个写操作之后马上读从库，可能从库还没来得及更新，这样就读到了旧版本的数据，称为`过期读`
