## 三次握手

TCP可靠传输的核心是`确认序列号`

三次握手就是为了让发送方和接收方都`知道对方`的序列号，并`确认对方已经知道了自己`的序列号，这样就能保证报文段的`顺序`

本来这一套流程由4个步骤（发送方为A，接收方为B）：

- 1.A发起连接请求，发送一个自己的随机初始序列号（ISN）`x`，以及`SYN置1`，`ACK置0`

- 2.B收到A的SYN请求，记录A的ISN x到本地

- 3.B向A发送同步信号`SYN置1`，`ACK置1`，确认号`x+1`，自己的初始序列号`y`

- 4.A收到B的SYN，知道B已经确认了自己序列为x的报文段，并保存y到本地，向B发送`x+1`，`SYN置1`，`ACK置1`，确认号`y+1`，这样B也知道了A已经确认自己序号为y的报文段，连接建立成功

其中2和3可以合并，就变成了三次握手

## 四次挥手

TCP连接的结束可以由任意一方发起

- 1.A发起关闭，`FIN置1`的报文段

- 2.B收到后发送ACK，B进入`CLOSE-WAIT`状态，A`不能`再向B发送数据，B可以向A发送未传完的数据

- 3.B向A发起关闭，`FIN置1`的报文段

- 4.A收到后发送ACK，这里A会进入`TIME-WAIT`状态，等待`2个MSL`（最大报文存活时间）后释放连接

最终B收到A的ACK，释放连接

CLOSE-WAIT发生在`被动`关闭方，大量产生的原因是程序没有及时关闭连接

TIME-WAIT发生在`主动`关闭方，大量产生的原因是默认时间太长（2个MLS 240秒）

CLOSE-WAIT作用：保证被动方能够把数据发送完

TIME-WAIT作用：

- 1.避免B`没有接收到`A的ACK报文，此时B会重传FIN报文，在TIME-WAIT状态可以再次ACK

- 2.等待本连接的报文数据在网络中消失，防止`下次连接`中出现本连接的数据